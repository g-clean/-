<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‰æ—¶åœˆåˆ†æ</title>
    
    <!-- ========================================= -->
    <!-- ğŸ”‘ APIå¯†é’¥é…ç½®åŒºåŸŸ - è¯·åœ¨æ­¤å¤„ä¿®æ”¹æ‚¨çš„é«˜å¾·åœ°å›¾APIå¯†é’¥ -->
    <!-- ========================================= -->
    <script>
        // é«˜å¾·åœ°å›¾APIå¯†é’¥ - è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å¯†é’¥
        const AMAP_API_KEY = "æ‚¨çš„APIå¯†é’¥";
        
        // å°†APIå¯†é’¥è®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–è„šæœ¬ä½¿ç”¨
        window.AKEY = AMAP_API_KEY;
    </script>
    <!-- ========================================= -->
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            padding: 0; /* ç§»é™¤ body çš„ paddingï¼Œè®©åœ°å›¾å¯ä»¥å æ»¡å…¨å± */
            /* å®Œå…¨ç§»é™¤èƒŒæ™¯ */
            min-height: 100vh;
            /* display: flex; align-items: flex-start; justify-content: center; */ /* ç§»é™¤ flex å¸ƒå±€ï¼Œå› ä¸ºåœ°å›¾å°†å…¨å±ï¼Œè¾“å…¥å¡ç‰‡å°†ç»å¯¹å®šä½ */
            overflow: hidden; /* é˜²æ­¢åœ°å›¾è¿‡å¤§æ—¶å‡ºç°æ»šåŠ¨æ¡ */
        }
        .input-card {
            width: 320px; /* ç¨å¾®åŠ å®½è¾“å…¥å¡ç‰‡ */
            /* min-height: 400px; */ /* é«˜åº¦ç”±å†…å®¹å†³å®š */
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow-y: auto; /* å¦‚æœå†…å®¹è¿‡å¤šï¼Œå…è®¸å¡ç‰‡å†…éƒ¨æ»šåŠ¨ */
            position: absolute; /* è®¾ç½®ä¸ºç»å¯¹å®šä½ */
            top: 20px; /* è·ç¦»é¡¶éƒ¨20px */
            left: 20px; /* è·ç¦»å·¦ä¾§20px */
            z-index: 10; /* ç¡®ä¿åœ¨åœ°å›¾ä¸Šå±‚ */
            max-height: calc(100vh - 40px); /* æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦å‡å»ä¸Šä¸‹è¾¹è· */
        }
        .input-card h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 8px;
        }
        .input-card .btn {
            margin-right: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #409EFF;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .input-card .btn:hover {
            background: #337ecc;
        }
        .input-item {
            margin-bottom: 60px; /* è°ƒæ•´é¡¹ä¹‹é—´çš„é—´è· */
            clear: both;
        }
        .input-item label {
            display: block;
            margin-bottom: 8px; /* å¢åŠ æ ‡ç­¾å’Œä¸‹æ–¹æ§ä»¶çš„é—´è· */
            color: #333; /* æ ‡ç­¾é¢œè‰²å˜æ·±ä¸€äº› */
            font-size: 14px;
            font-weight: bold; /* æ ‡ç­¾åŠ ç²— */
        }
        /* ç‹¬ç«‹çš„æç¤ºæ–‡å­—æ ·å¼ */
        .label-text {
            display: block;
            margin-bottom: 18px;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #409EFF;
        }
        .input-item input, .input-item select, .input-item textarea {
            width: 100%;
            padding: 10px; /* ç»Ÿä¸€å†…è¾¹è· */
            border: 1px solid #ccc; /* è¾¹æ¡†é¢œè‰²è°ƒæ•´ */
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            box-sizing: border-box;
            transition: border-color 0.3s;
            min-height: 40px;
        }
        /* å•ç‚¹è¾“å…¥æ¡†ç‰¹æ®Šæ ·å¼ - ç¡®ä¿è¶³å¤Ÿå®½åº¦ */
        #lnglat {
            min-width: 200px; /* ç¡®ä¿è‡³å°‘10ä¸ªå­—ç¬¦å®½åº¦ */
            width: 100% !important;
        }
        .input-item input:focus, .input-item select:focus, .input-item textarea:focus {
            outline: none;
            border-color: #409EFF;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }
        /* ç¡®ä¿selectä¸‹æ‹‰é€‰é¡¹æ­£å¸¸æ˜¾ç¤º */
         .input-item select {
             position: relative;
             z-index: 2;
             background: white;
             appearance: auto;
             -webkit-appearance: auto;
             -moz-appearance: auto;
         }
         .input-item select:focus {
             z-index: 3;
         }
         /* è¾“å…¥æ¨¡å¼é€‰æ‹©æ ·å¼ */
          #inputMode {
              background: #f8f9fa;
              font-weight: 500;
              position: relative;
              z-index: 2;
          }
          #inputMode:focus {
              z-index: 3;
          }
          /* äº¤é€šæ–¹å¼é€‰æ‹©æ ·å¼ */
          #transport {
              position: relative;
              z-index: 2;
          }
          #transport:focus {
              z-index: 3;
          }
        /* æ‰¹é‡è¾“å…¥åŒºåŸŸç‰¹æ®Šæ ·å¼ */
         #batchInput {
             margin-bottom: 30px !important;
             padding: 15px;
             background: #f8f9fa;
             border-radius: 6px;
             border: 1px solid #e9ecef;
             position: relative;
             z-index: 1;
         }
         #batchInput label {
             color: #495057;
             font-weight: 600;
             margin-bottom: 8px;
         }
         #batchCoords {
             font-family: 'Consolas', 'Monaco', monospace;
             line-height: 1.6; /* ç¨å¾®å¢åŠ è¡Œé«˜ï¼Œæ”¹å–„å¯è¯»æ€§ */
             resize: vertical;
             min-height: 50px; /* å‡å°‘æœ€å°é«˜åº¦ */
         }
         /* å¤šç‚¹é€‰æ‹©åŒºåŸŸæ ·å¼ */
         #multiClickInput {
             margin-bottom: 30px;
             padding: 15px;
             background: #f0f8ff;
             border-radius: 6px;
             border: 1px solid #b3d9ff;
             position: relative;
             z-index: 1;
         }
         #multiClickInput label {
             color: #0066cc;
             font-weight: bold; /* ä¸å…¶ä»–labelä¿æŒä¸€è‡´ */
             margin-bottom: 8px;
         }
         #multiClickInput p {
            margin-bottom: 8px; /* è°ƒæ•´å¤šç‚¹è¾“å…¥æç¤ºæ–‡å­—çš„é—´è· */
            line-height: 1.4;
         }
        #clearPoints {
            background: #6c757d !important;
            font-size: 12px !important;
            padding: 4px 12px !important;
            margin-top: 8px;
        }
        #clearPoints:hover {
            background: #545b62 !important;
        }
        /* æ¨¡å¼é€‰æ‹©åŒºåŸŸæ ·å¼ */
         .mode-select {
             background: #e8f4fd;
             padding: 15px;
             border-radius: 6px;
             border-left: 4px solid #007bff;
             margin-bottom: 25px;
             position: relative;
             z-index: 1;
         }
         .mode-select label {
             color: #004085;
             font-weight: 600;
             margin-bottom: 8px;
         }
         /* ç‚¹å‡»ä¿¡æ¯æ ·å¼ */
          .click-info {
              margin: 10px 0;
              font-size: 12px;
              color: #666;
              padding: 8px 12px;
              background: #f8f9fa;
              border-radius: 4px;
              border: 1px solid #dee2e6;
              position: relative;
              z-index: 1;
          }
          /* é€šè¡Œæ—¶é—´å’Œäº¤é€šæ–¹å¼åŒºåŸŸå¼ºè°ƒ */
          .time-input, .transport-input {
              background: #fff9e6;
              padding: 15px;
              border-radius: 6px;
              border-left: 4px solid #ffc107;
              margin-bottom: 25px;
              position: relative;
              z-index: 1;
          }
          .time-input label, .transport-input label {
              color: #856404;
              font-weight: 600;
              margin-bottom: 8px;
          }
        /* è¿›åº¦æ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        #progressArea {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #c3e6c3;
            margin-top: 15px;
        }
        #progressText {
            font-weight: 600;
            color: #155724;
        }
        /* æŒ‰é’®åŒºåŸŸæ ·å¼ */
        .button-area {
            display: flex; /* ä½¿ç”¨flexå¸ƒå±€è®©æŒ‰é’®å¹¶æ’ */
            justify-content: flex-end; /* æŒ‰é’®ç»„å³å¯¹é½ */
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .button-area button { /* ç›´æ¥é€‰æ‹©buttonå…ƒç´  */
            margin-left: 10px; /* æŒ‰é’®ä¹‹é—´çš„å·¦è¾¹è· */
            padding: 10px 18px; /* å¢å¤§æŒ‰é’®å†…è¾¹è· */
            border: none;
            border-radius: 4px;
            background-color: #007bff; /* ä¸»æŒ‰é’®é¢œè‰² */
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .button-area button:hover {
            background-color: #0056b3;
        }
        .button-area button#clearBtn { /* æ¸…é™¤æŒ‰é’®ç‰¹å®šæ ·å¼ */
            background-color: #6c757d;
        }
        .button-area button#clearBtn:hover {
            background-color: #545b62;
        }
        .input-item:last-child {
            text-align: center;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        #clear {
            background: #6c757d !important;
        }
        #clear:hover {
            background: #545b62 !important;
        }
        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #container {
            width: 100vw; /* è§†å£å®½åº¦ */
            height: 100vh; /* è§†å£é«˜åº¦ */
            position: absolute; /* ç»å¯¹å®šä½ */
            top: 0;
            left: 0;
            z-index: 0; /* åœ¨è¾“å…¥å¡ç‰‡ä¸‹å±‚ */
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div class="input-card">
            <h2>ç­‰æ—¶åœˆå‚æ•°è®¾ç½®</h2>
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="input-item">
                <label for="inputMode">è¾“å…¥æ¨¡å¼:</label>
                <select id="inputMode">
                    <option value="single">å•ç‚¹è¾“å…¥</option>
                    <option value="multiClick">å¤šç‚¹åœ°å›¾é€‰æ‹©</option>
                    <option value="multiBatch">æ‰¹é‡åæ ‡è¾“å…¥</option>
                </select>
            </div>

          <!-- å•ç‚¹è¾“å…¥ -->
            <div id="singleInput" class="input-item" style="margin-bottom: 60px;">
                <label for="lnglat">åæ ‡ (ç»åº¦,çº¬åº¦):</label>
                <input type="text" id="lnglat" placeholder="ä¾‹å¦‚: 116.397428,39.90923">
            </div>

            <!-- å¤šç‚¹åœ°å›¾é€‰æ‹© -->
            <div id="multiClickInput" class="input-item" style="margin-bottom: 60px;">
                <p>è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©è®¾æ–½ç‚¹ï¼Œæœ€å¤šå¯é€‰10ä¸ªç‚¹ã€‚</p>
                <p>å·²é€‰ç‚¹æ•°: <span id="clickCount">0</span>/10</p>
                <button id="clearSelectedPointsBtn">æ¸…é™¤é€‰æ‹©</button>
            </div>

            <!-- æ‰¹é‡åæ ‡è¾“å…¥ -->
            <div id="batchInput" class="input-item" style="margin-bottom: 60px;">
                <label for="batchCoords">æ‰¹é‡åæ ‡ (æ¯è¡Œä¸€å¯¹,é€—å·åˆ†éš”):</label>
                <textarea id="batchCoords" rows="3" placeholder="ä¾‹å¦‚:
116.397428,39.90923
116.403428,39.90923
116.407428,39.91923"></textarea>
            </div>

            <!-- æ—¶é—´è®¾ç½® -->
            <div class="input-item" style="margin-top: 70px;">
                <label for="time">æ—¶é—´ (åˆ†é’Ÿ):</label>
                <input type="number" id="time" value="30" min="1" max="120">
            </div>

            <!-- äº¤é€šæ–¹å¼ -->
            <div class="input-item" style="margin-top: 20px;">
                <label for="transport">äº¤é€šæ–¹å¼:</label>
                <select id="transport">
                    <option value="driving">é©¾è½¦</option>
                    <option value="walking">æ­¥è¡Œ</option>
                    <option value="riding">éª‘è¡Œ</option>
                    <option value="bus">å…¬äº¤</option> 
                </select>
            </div>

            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="button-area" style="margin-top: 20px;">
                <button id="generateBtn">è®¡ç®—ç­‰æ—¶åœˆ</button>
                <button id="clearBtn">æ¸…é™¤ç»“æœ</button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progressArea" style="display: none; margin-top: 10px;">
                <p id="progressText">0/0</p>
                <div style="background-color: #e0e0e0; border-radius: 5px;">
                    <div id="progressBar" style="width: 0%; height: 10px; background-color: #4CAF50; border-radius: 5px;"></div>
                </div>
            </div>
        </div>

    <!-- é«˜å¾·åœ°å›¾APIè„šæœ¬ - ä½¿ç”¨é¡¶éƒ¨é…ç½®çš„å¯†é’¥ -->
    <script>
        // åŠ¨æ€æ„å»ºé«˜å¾·åœ°å›¾API URL
        const amapScriptUrl = `https://webapi.amap.com/maps?v=2.0&key=${AMAP_API_KEY}&securityJsCode=${AMAP_SECURITY_JS_CODE}`;
        document.write(`<script src="${amapScriptUrl}"><\/script>`);
    </script>
    <script src="js/isochrone.js"></script>
    <script>
        // åˆ›å»ºåœ°å›¾å®ä¾‹
        // åˆ›å»ºCanvaså…ƒç´ å¹¶è®¾ç½®willReadFrequentlyå±æ€§
        const container = document.getElementById('container');
        const canvas = document.createElement('canvas');
        canvas.setAttribute('willReadFrequently', 'true');
        container.appendChild(canvas);

        // åˆ›å»ºåœ°å›¾å®ä¾‹
        const map = new AMap.Map('container', {
            zoom: 12,
            center: [118.11022, 24.49047], // é»˜è®¤ä¸­å¿ƒç‚¹ï¼šå¦é—¨å¸‚
            viewMode: '2D'
        });

        // åˆ›å»ºç­‰æ—¶åœˆç®¡ç†å™¨å®ä¾‹
        const isochroneManager = new IsochroneManager(map);
        
        // æ‰¹é‡è¾“å…¥ç›¸å…³å˜é‡
        let selectedPoints = []; // å­˜å‚¨å¤šç‚¹é€‰æ‹©çš„åæ ‡
        let currentInputMode = 'single'; // å½“å‰è¾“å…¥æ¨¡å¼
        
        // è¾“å…¥æ¨¡å¼åˆ‡æ¢
        const inputModeSelect = document.getElementById('inputMode');
        const singleInput = document.getElementById('singleInput');
        const multiClickInput = document.getElementById('multiClickInput');
        const batchInput = document.getElementById('batchInput');
        // currentInputMode is already declared globally and initialized to 'single'.

        function switchInputMode(mode) {
            currentInputMode = mode; // Assigns to the global currentInputMode
            // å…ˆéšè—æ‰€æœ‰ç‰¹å®šæ¨¡å¼çš„è¾“å…¥åŒºåŸŸ
            singleInput.style.display = 'none';
            multiClickInput.style.display = 'none';
            batchInput.style.display = 'none';

            // é‡ç½®è¾¹è·
            singleInput.style.marginTop = '0';
            multiClickInput.style.marginTop = '0';
            batchInput.style.marginTop = '0';

            // æ ¹æ®é€‰æ‹©çš„æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥åŒºåŸŸ
            if (mode === 'single') {
                singleInput.style.display = 'block';
            } else if (mode === 'multiClick') {
                multiClickInput.style.display = 'block';
                // multiClickInput.style.marginTop = '5em'; // æ ¹æ®ä¹‹å‰çš„éœ€æ±‚ï¼Œå¦‚æœéœ€è¦ä¸‹ç§»ï¼Œåœ¨æ­¤å¤„å–æ¶ˆæ³¨é‡Š
            } else if (mode === 'multiBatch') {
                batchInput.style.display = 'block';
                // batchInput.style.marginTop = '5em'; // æ ¹æ®ä¹‹å‰çš„éœ€æ±‚ï¼Œå¦‚æœéœ€è¦ä¸‹ç§»ï¼Œåœ¨æ­¤å¤„å–æ¶ˆæ³¨é‡Š
            }
        }

        inputModeSelect.addEventListener('change', function() {
            switchInputMode(this.value);
        });
        // åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ä»¥è®¾ç½®é»˜è®¤æ¨¡å¼çš„æ˜¾ç¤º
        switchInputMode(currentInputMode); // Uses the global currentInputMode
        
         // æ¸…é™¤é€‰æ‹©çš„ç‚¹
        const clearSelectedPointsBtn = document.getElementById('clearSelectedPointsBtn');
        function clearSelectedPoints() {
            selectedPoints = [];
            isochroneManager.clearAllIsochrones(); // æ¸…é™¤æ‰€æœ‰æ ‡è®°å’Œç­‰æ—¶åœˆ
            updateClickCount();
        }
        if(clearSelectedPointsBtn) clearSelectedPointsBtn.addEventListener('click', clearSelectedPoints);

        // æ›´æ–°ç‚¹å‡»è®¡æ•°
        const clickCountSpan = document.getElementById('clickCount');
        function updateClickCount() {
            if(clickCountSpan) clickCountSpan.textContent = selectedPoints.length;
        }

        // åœ°å›¾ç‚¹å‡»äº‹ä»¶
        map.on('click', function(e) {
            const lng = e.lnglat.getLng().toFixed(6); // ä¿ç•™6ä½å°æ•°
            const lat = e.lnglat.getLat().toFixed(6); // ä¿ç•™6ä½å°æ•°

            if (currentInputMode === 'single') {
                // å¦‚æœæ˜¯å•ç‚¹è¾“å…¥æ¨¡å¼ï¼Œåˆ™å°†ç‚¹å‡»çš„åæ ‡å¡«å……åˆ°è¾“å…¥æ¡†
                const lnglatInput = document.getElementById('lnglat');
                if (lnglatInput) {
                    lnglatInput.value = `${lng},${lat}`;
                }
            } else if (currentInputMode === 'multiClick') {
                // å¦‚æœæ˜¯å¤šç‚¹åœ°å›¾é€‰æ‹©æ¨¡å¼
                if (selectedPoints.length < 10) {
                    const point = [parseFloat(lng), parseFloat(lat)];
                    selectedPoints.push(point);
                    isochroneManager.addFacilityMarker(point); // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°
                    updateClickCount(); // æ›´æ–°å·²é€‰ç‚¹æ•°æ˜¾ç¤º
                } else {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©10ä¸ªç‚¹');
                }
            }
            // æ‰¹é‡åæ ‡è¾“å…¥æ¨¡å¼ä¸‹ï¼Œåœ°å›¾ç‚¹å‡»ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        });


        // ç”Ÿæˆç­‰æ—¶åœˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const generateBtn = document.getElementById('generateBtn'); // åœ¨ç›‘å¬å™¨å¤–éƒ¨è·å–æŒ‰é’®å…ƒç´ 

        const clearBtn = document.getElementById('clearBtn'); // åœ¨ç›‘å¬å™¨å¤–éƒ¨è·å–æŒ‰é’®å…ƒç´ 

        generateBtn.addEventListener('click', async () => {
            const timeInput = document.getElementById('time');
            const transportSelect = document.getElementById('transport');
            const lnglatInput = document.getElementById('lnglat');
            const batchCoordsTextarea = document.getElementById('batchCoords');
            
            const time = parseInt(timeInput.value);
            const transport = transportSelect.value;
            
            // éªŒè¯é€šè¡Œæ—¶é—´
            if (isNaN(time) || time < 1 || time > 120) {
                alert('è¯·è¾“å…¥1-120åˆ†é’Ÿä¹‹é—´çš„é€šè¡Œæ—¶é—´');
                return;
            }
            
            let facilityPoints = [];
            
            if (currentInputMode === 'single') {
                const lnglatStr = lnglatInput.value.split(',');
                if (lnglatStr.length !== 2 || isNaN(parseFloat(lnglatStr[0])) || isNaN(parseFloat(lnglatStr[1]))) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åæ ‡ï¼Œæ ¼å¼ä¸ºï¼šç»åº¦,çº¬åº¦');
                    return;
                }
                facilityPoints.push([parseFloat(lnglatStr[0]), parseFloat(lnglatStr[1])]);
            } else if (currentInputMode === 'multiClick') {
                if (selectedPoints.length === 0) {
                    alert('è¯·åœ¨åœ°å›¾ä¸Šé€‰æ‹©è‡³å°‘ä¸€ä¸ªè®¾æ–½ç‚¹');
                    return;
                }
                facilityPoints = [...selectedPoints];
            } else if (currentInputMode === 'multiBatch') {
                const batchText = batchCoordsTextarea.value.trim();
                if (!batchText) {
                    alert('è¯·è¾“å…¥æ‰¹é‡åæ ‡');
                    return;
                }
                const lines = batchText.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const coords = line.split(',');
                        if (coords.length !== 2 || isNaN(parseFloat(coords[0])) || isNaN(parseFloat(coords[1]))) {
                            alert(`ç¬¬${i + 1}è¡Œåæ ‡æ ¼å¼é”™è¯¯ï¼š${line}`);
                            return;
                        }
                        facilityPoints.push([parseFloat(coords[0]), parseFloat(coords[1])]);
                    }
                }
                if (facilityPoints.length === 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åæ ‡');
                    return;
                }
            }
            
            // æ‰€æœ‰éªŒè¯é€šè¿‡åï¼Œç¦ç”¨æŒ‰é’®å¹¶å¼€å§‹è®¡ç®—
            const originalText = generateBtn.textContent; // ä½¿ç”¨å¤–éƒ¨å·²è·å–çš„ generateBtn
            generateBtn.disabled = true; // ç¦ç”¨è®¡ç®—æŒ‰é’®
            clearBtn.disabled = true; // ç¦ç”¨æ¸…é™¤æŒ‰é’®
            generateBtn.textContent = 'è®¡ç®—ä¸­...';
            
            showProgress(0, facilityPoints.length); // åˆå§‹åŒ–è¿›åº¦
            
            // ä½¿ç”¨é¡¶éƒ¨é…ç½®åŒºåŸŸå®šä¹‰çš„å…¨å±€å¸¸é‡ AKEY
            const apiKey = window.AKEY; 

            if (!apiKey) { // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®
                alert('API Key æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥é¡¶éƒ¨é…ç½®åŒºåŸŸçš„å¯†é’¥è®¾ç½®');
                generateBtn.disabled = false; // é‡æ–°å¯ç”¨è®¡ç®—æŒ‰é’®
                clearBtn.disabled = false; // é‡æ–°å¯ç”¨æ¸…é™¤æŒ‰é’®
                generateBtn.textContent = originalText; // æ¢å¤æŒ‰é’®æ–‡æœ¬
                const progressAreaElement = document.getElementById('progressArea');
                if (progressAreaElement) progressAreaElement.style.display = 'none'; // éšè—è¿›åº¦æ¡
                return;
            }

            try {
                await isochroneManager.generateIsochrones(facilityPoints, time, transport, apiKey, (index, total) => { showProgress(index, total); }); // è°ƒç”¨isochroneManagerç”Ÿæˆç­‰æ—¶åœˆï¼Œå¹¶ä¼ å…¥è¿›åº¦å›è°ƒ
            } catch (error) {
                console.error('ç”Ÿæˆç­‰æ—¶åœˆæ—¶å‘ç”Ÿé”™è¯¯:', error);
                // ç›´æ¥æ˜¾ç¤ºåŸå§‹é”™è¯¯ä¿¡æ¯
                alert('ç”Ÿæˆç­‰æ—¶åœˆå¤±è´¥: ' + (error.message || error.toString() || error));
            } finally {
                try {
                    // éšè—è¿›åº¦æ¡
                    const progressAreaElement = document.getElementById('progressArea');
                    if (progressAreaElement) {
                        progressAreaElement.style.display = 'none';
                        console.log('è¿›åº¦æ¡å·²éšè—');
                    }
                    
                    // å¯ç”¨è®¡ç®—æŒ‰é’®
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        console.log('è®¡ç®—æŒ‰é’®å·²å¯ç”¨');
                    }
        
                    // å¯ç”¨æ¸…é™¤æŒ‰é’®
                    if (clearBtn) {
                        clearBtn.disabled = false;
                        console.log('æ¸…é™¤æŒ‰é’®å·²å¯ç”¨');
                    }
                    
                    // æ¢å¤æŒ‰é’®æ–‡æœ¬
                    if (generateBtn) {
                        generateBtn.textContent = originalText;
                        console.log('æŒ‰é’®æ–‡æœ¬å·²æ¢å¤ä¸º:', originalText);
                    }
                } catch (finallyError) {
                    console.error('finallyå—æ‰§è¡Œå‡ºé”™:', finallyError);
                    // å¼ºåˆ¶æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = originalText; // ç¡®ä¿æŒ‰é’®æ–‡æœ¬ä¹Ÿè¢«æ¢å¤
                    }
                    if (clearBtn) clearBtn.disabled = false;
                }
            }
        });



        // æ¸…é™¤ç»“æœæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        // clearBtn å·²åœ¨å¤–éƒ¨è·å–ï¼Œæ­¤å¤„ç›´æ¥ä½¿ç”¨
        clearBtn.addEventListener('click', () => {
            isochroneManager.clearAllIsochrones(); // æ¸…é™¤æ‰€æœ‰ç­‰æ—¶åœˆå’Œæ ‡è®°
            if(document.getElementById('lnglat')) document.getElementById('lnglat').value = '';
            if(document.getElementById('batchCoords')) document.getElementById('batchCoords').value = '';
            clearSelectedPoints(); // æ¸…é™¤åœ°å›¾ä¸Šçš„ç‚¹å’Œè®¡æ•°
            hideProgress();
        });

        // æ˜¾ç¤ºè¿›åº¦å‡½æ•°
        // æ˜¾ç¤ºè¿›åº¦å‡½æ•°
        function showProgress(current, total) {
            const progressAreaElement = document.getElementById('progressArea');
            const progressTextElement = document.getElementById('progressText');
            const progressBarElement = document.getElementById('progressBar');
            if(progressAreaElement) progressAreaElement.style.display = 'block';
            if(progressTextElement) progressTextElement.textContent = `${current}/${total}`;
            if(progressBarElement) progressBarElement.style.width = total > 0 ? `${(current / total) * 100}%` : '0%';
        }

        // éšè—è¿›åº¦å‡½æ•°
        function hideProgress() {
            const progressAreaElement = document.getElementById('progressArea');
            if(progressAreaElement) setTimeout(() => { progressAreaElement.style.display = 'none'; }, 1000);
        }
    </script>
</body>
</html>